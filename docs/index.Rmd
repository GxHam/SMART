---
# title: "SMART:\nSemi-manual alignment to reference templates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# SMART: Semi-manual alignment to reference templates
***

Author(s):
Maintainer: Michelle Jin 
- michelle.jin@nih.gov 
- <span style="color:#337ab7">@</span>[Michelle_Jin1](https://twitter.com/michelle_jin1)

Contributor: Joseph Nguyen 
- jdnguyen@email.wm.edu

### Introduction:
This package builds a pipeline interfacing with the
[wholebrain](https://github.com/tractatus/wholebrain) package ^[Daniel Furth -
@wholebrainsuite (2015). wholebrain: Functions to segment and register cells
  from microscopic image files with R. R package version 0.1.1.] to process
  whole brain imaging datasets. Datasets of a handful of single slice images
  across the brain can also be fed into this pipeline. For brevity, I'll refer
  to these datasets as partial brains.

There are five main advancements that SMART builds on top of the wholebrain
base package:
  
1. Guides the user through setting up analysis parameters and feeds the imaging
data through registration, segmentation, and forward warp process. It automates
looping through these analyses with simple function calls so the user does not
have to set up this looping.

2. Provides a user-friendly interface whenever possible. This includes a console
interface during the registration process, that allows for easy adding,
changing, and removing correspondence points or reverting back to a previous
correspondence change.

3. Helps to solve non-linear relationships between atlas AP coordinates to
actual distances in the anterior-posterior axis in real imaging datasets. This
is critical when dealing with tissue clearing methods that cause non-uniform
tissue morphing across the AP-axis.

4. Organizes and stores the output of wholebrain analysis in automatically
generated subdirectories. This standardized organization will be
beneficial when sharing data output from wholebrain.

5. Provides more ways to parse whole brain datasets and visualize data across
ROIs.

*Disclaimer. This package is intended for coronal plane datasets. Preprocessing
must be done to align the dataset coronally before it should be analyzed with
the pipeline.*


**Below is an illustratratration of the pipeline schematic:**
![](C:/Users/mjin1/Documents/GitHub/SMART/schematics/pipeline_schematic.PNG)

***

###Installation of SMART:

To use SMART, wholebrain must first be installed. The instructions to install
wholebrain can be found [here](http://www.wholebrainsoftware.org/cms/install).
Please note, if you are using a windows machine, manual installation of opencv
is no longer necessary. I highly recommend reading through some of the documentation 
for wholebrain before using this package. 

SMART is easily installed from github using the devtools package:

```{r, eval = FALSE}
# Load devtools
library(devtools) 
 
# Install SMART
devtools::install_github("mjin1812/SMART")

# Load SMART
library(SMART)

# Pull up package descriptions and list of functions
?SMART
```

***

### Pipeline breakdown:
As illustrated in the schematic and stated in the package descriptions, not all
parts of this pipeline will be used when analyzing a partial brain. Sections/functions exclusively meant to be used with whole brain datasets will be marked with **(W)**. Additionally, some package functions may be useful for analysis outside the pipeline we present here.

For processing a wholebrain dataset, the pipeline is split into 5 sections. These sections are listed below along with the functions that belong to each section:

**Part 1: Setup pipeline**

+ [`setup_pl()`](#id1)  User friendly way to setup parameters for whole or partial brain pipeline analysis.
+ [`im_sort()`](#id2) A function to sort image paths for imaging datasets.
+ [`get_savepaths()`](#id3) Generate savepaths and save directories.

**Part 2: Alignment (W) **

+ [`choice()`](#id4)  **(W)** User friendly choice game to align internal reference atlas plates.
+ [`brainmorph()`](#id5) **(W)** Generate a brain morph plot.
+ [`interpolate()`](#id6)**(W)** Interpolate all AP and z numbers for atlas plates in a whole brain project   

**Part 3: Registration**

+ [`registration2()`](#id7) Console user interface built on top of registration() function from the wholebrain package.
+ [`regi_loop()`](#id8) Automatically loops through the image registration process for the imaging dataset.

**Part 4: Segmentation, duplicate cleanup, & forward warping**

+ [`filter_loop()`](#id9) Loops through reference slices and allows user to check/change filter settings for segmentation or registration.
+ [`seg_loop()`](#id10)   Loop through and segments images in the segmentation channel.
+ [`clean_duplicates()`](#id11) **(W)** Duplicate cell count clean up of segmentation output.
+ [`forward_warp()`](#id12) Performs forward warp loop back onto atlas space using segmentation and registration output.

**Part 5. Dataset manipulation and plotting**

+ [`get_rois()`](#id13) Gets a subset of the forward warped dataframe of just regions of interest.
+ [`get_sunburst()`](#id14) Generates a sunburst plot using a forward warped dataset.
+ [`get_tree()`](#id15) Creates a dataframe of hierarchical region cell count data.
+ [`glassbrain2()`](#id16) Generates a 3D plot of cells counts with option of removing glassbrain in the background.

Below is a walkthrough of each of these functions and the pipeline as a whole
using an example whole brain dataset. Feel free to use the function links above
to skip sections!

For convention, if a return value is given by a function, the recommended variable name is indicated in italics in the return section of each function's help page. If this return value is a required argument for another function in the pipeline, the recommended variable name will also be the same name as the argument.




